UPDATE AP
SET 
    DIAGNOSTICO_PRINCIPAL = COALESCE(
        (SELECT AC.CODIGO_DEL_DIAGNOSTICO_PRINCIPAL
         FROM AC
         WHERE AC.NUMERO_DE_IDENTIFICACION_DEL_USUARIO_EN_EL_SISTEMA = AP.NUMERO_DE_IDENTIFICACION_DEL_USUARIO_EN_EL_SISTEMA
         AND AC.CODIGO_DEL_DIAGNOSTICO_PRINCIPAL IN (
            'O308', 'O309', 'O000', 'O001', 'O002', 'O008', 'O009', 'O080', 'O081', 'O082', 'O083', 'O084', 'O085', 'O086', 'O087', 'O088', 'O089',
            'O100', 'O101', 'O102', 'O103', 'O104', 'O109', 'O13X', 'O150', 'O208', 'O209', 'O218', 'O219', 'O220', 'O221', 'O222', 'O223', 'O224',
            'O225', 'O228', 'O229', 'O230', 'O231', 'O232', 'O233', 'O234', 'O235', 'O239', 'O240', 'O241', 'O242', 'O243', 'O244', 'O249', 'O25X',
            'O260', 'O261', 'O262', 'O263', 'O266', 'O267', 'O268', 'O269', 'O290', 'O291', 'O292', 'O293', 'O294', 'O295', 'O296', 'O298', 'O299',
            'O300', 'O301', 'O302', 'O311', 'O312', 'O318', 'O325', 'O367', 'O48X', 'O833', 'O94X', 'O980', 'O981', 'O982', 'O983', 'O984', 'O985',
            'O986', 'O987', 'O988', 'O989', 'O990', 'O991', 'O992', 'O993', 'O994', 'O995', 'O996', 'O997', 'O998', 'P014', 'P015', 'P018', 'P019',
            'P040', 'P964', 'Z320', 'Z321', 'Z33X', 'Z340', 'Z348', 'Z349', 'Z350', 'Z351', 'Z352', 'Z353', 'Z354', 'Z357', 'Z358', 'Z359', 'Z640',
            'Z875', 'G932', 'I10X', 'I150', 'I151', 'I152', 'I158', 'I159', 'I270', 'I272', 'K766', 'O100', 'O104', 'O109', 'O11X', 'O13X', 'O16X',
            'P292', 'R030'
         )
         AND AC.FECHA_DE_LA_CONSULTA = AP.fecha_del_procedimiento
         LIMIT 1
        ),
        (SELECT AC.CODIGO_DEL_DIAGNOSTICO_PRINCIPAL
         FROM AC
         WHERE AC.NUMERO_DE_IDENTIFICACION_DEL_USUARIO_EN_EL_SISTEMA = AP.NUMERO_DE_IDENTIFICACION_DEL_USUARIO_EN_EL_SISTEMA
         AND AC.FECHA_DE_LA_CONSULTA = AP.fecha_del_procedimiento
         LIMIT 1)
    ),
    DIAGNOSTICO_RELACIONADO = COALESCE(
        (SELECT AC.CODIGO_DEL_DIAGNOSTICO_RELACIONADO_NO_1
         FROM AC
         WHERE AC.NUMERO_DE_IDENTIFICACION_DEL_USUARIO_EN_EL_SISTEMA = AP.NUMERO_DE_IDENTIFICACION_DEL_USUARIO_EN_EL_SISTEMA
         AND AC.FECHA_DE_LA_CONSULTA = AP.fecha_del_procedimiento
         LIMIT 1),
        AP.DIAGNOSTICO_RELACIONADO
    )
WHERE AP.NUMERO_DE_IDENTIFICACION_DEL_USUARIO_EN_EL_SISTEMA IN (
    SELECT AC.NUMERO_DE_IDENTIFICACION_DEL_USUARIO_EN_EL_SISTEMA
    FROM AC
    WHERE AC.FECHA_DE_LA_CONSULTA = AP.fecha_del_procedimiento
);